---
title: Rotating Certificates with Customer-Provided CAs
owner: Ops Manager
---

This topic describes how to handle customer-provided certificate authorities (CAs) during an <%= vars.ops_manager %> certificate rotation.


## <a id='overview'></a> Overview of Customer-Provided CAs

CredHub Maestro requires that you perform manual steps at the beginning of the certificate rotation process to correctly handle customer-provided CAs. 

You can use one of two methods to handle customer-provided CAs. Both methods are equally effective, but each method works at a different point in the certificate rotation process. 

- If you have not started the certificate rotation process, you can use <strong>Method One</strong>. To use this method, see [Method One: Tell CredHub Maestro to Ignore Customer-Provided CAs](#method-one) below. 

- If you are already in the process of rotating certicates, you can use <strong>Method Two</strong>. To use this method, see [Method Two: Manually Replace the Customer-Provided CAs](#method-two) below. You can use this procedure after encountering the following Maestro error:
   <pre>certificate authorities latest version is not transitional</pre>

If you are unsure whether customer-provided CAs are installed, see [Check for Customer-Provided CAs](#ca-check) below.

## <a id='ca-check'></a> Check for Customer-Provided CAs

Determine if there are customer-provided CAs and record the CredHub path to any installed CAs.

You can identify customer-provided CAs in one of the following ways:

<strong>1. From the Ops Manager `Certificates` page:</strong><br/>
Customer-provided CAs will have the properties<br/>
`Location` = `credhub`<br/>
`Type` = `CA`<br/>
`Configurable` = `true`<br/>
The CredHub Path to the CA will appear in the `Certificate name` column.

<strong>2. From the `api/v0/deployed/certificates` endpoint:</strong><br/>
Customer-provided CAs will have the properties<br/>
`configurable` = `true`<br/>
`location` = `credhub`<br/>
`is_ca` = `true`<br/>
The CredHub Path to the CA will appear in the `variable_path` property.

<strong>3. Directly from CredHub:</strong><br/>
Customer-provided CAs will have the properties<br/>
`generated` = `false`<br/>
`certificate_authority` = `true`<br/>

If no Customer-provided CAs are found, then Certificate Rotation can proceed as normal, and the remainder of this document can be ignored.

## <a id='method-one'></a> Method One: Tell CredHub Maestro to Ignore Customer-Provided CAs

Pass the list of CredHub paths to the customer-provided CAs to the `exclude_from_rotation` parameter to either the `api/v0/certificate_authorities/generate` or the `api/v0/certificate_authorities` endpoint.

The payload that must be provided to the request has the following structure:

```
{
  "exclude_from_rotation": {
    "certificate_authorities": ["/services/tls_ca", "/credhub/path/to/user_provided_ca1", "/credhub/path/to/user_provided_ca2"]
  }
}
```

<p class="note"><strong>Note:</strong> You will need to get the CredHub paths to the customer-provided CAs. The procedure to do this is detailed in the "Prerequisites" section of this document.</p>

<p class="note warning"><strong>Warning:</strong> the "/services/tls_ca" CA <strong>must</strong> be included along with the paths to the customer-provided CAs. Failure to include this CA in the list of CAs will result in service disruption during the certificate rotation process.</p>

Once you successfully make this request, you can proceed with the normal Certificate Rotation process.

## <a id='method-two'></a> Method Two: Manually Replace the Customer-Provided CAs

This method must be performed after rotation has been started; it cannot be performed before rotation has started. It should be performed immediately after rotation has been started, but can be performed after Maestro emits the `certificate authorities latest version is not transitional` error.

The steps in this method are as follows:

1. Use `credhub set` to update each customer-provided CA with a new version of that CA.

2. Use `credhub curl` on the `api/v1/certificates/:certificate_id/update_transitional_version` API endpoint to set the transitional flag for each customer-provided CA.

Because there are already customer-provided CAs loaded into CredHub, it is assumed that you are familar with the `credhub set` command, so no further guidance on that command will be provided.

The structure of the `credhub curl` invocation to set the `transitional` flag on the CAs is as follows:

```
credhub curl -i -X PUT -p api/v1/certificates/$CERTIFICATE_ID/update_transitional_version -d '{"version": "$VERSION_ID"}'
```

So, in order to set the `transitional` flag, you must gather the certificate ID of each certificate and the version ID of the latest version of each certificate.

To retrieve the certificate ID of each certificate that must be updated, consult the output of `maestro topology`. Search the `versions` array associated with the certificate for an item that has a `valid_until` date that matches the expiry date of the certificate that was loaded with `credhub set`.

The response from `maestro topology` might look like:

```
topology:
    - name: /customer-provided-ca
      certificate_id: 75b9f5a6-f3c6-42f8-a834-3cfa6098c73a
      signed_by: /customer-provided-ca
      versions:
        - version_id: 7e172086-a08d-4e62-98ba-308942a52e8a
          certificate_authority: true
          generated: false
          valid_until: 2022-04-09T21:20:23Z
        - version_id: b942c826-e64b-4a75-8a9a-9dd109551daf
          active: true
          signing: true
          certificate_authority: true
          generated: false
          valid_until: 2022-04-09T21:19:55Z
      signs:
        - name: /bosh_dns_health_client_tls
          certificate_id: cba8b8e7-e7ec-4584-bce1-e41d75f1511b
          signed_by: /customer-provided-ca
          versions:
            - version_id: b70ae8c0-91a5-4155-9545-a4c6e921bb03
              generated: true
              active: true
              valid_until: 2022-04-09T23:30:45Z
```

Given this output, you will use the `update_transitional_version` endpoint on the certificate with the id `75b9f5a6-f3c6-42f8-a834-3cfa6098c73a` and the version with the id `7e172086-a08d-4e62-98ba-308942a52e8a`.

After performing this operation on each customer-provided CA, you can continue with the normal Certificate Rotation process.

